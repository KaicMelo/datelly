<!DOCTYPE HTML>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8">

		<title>Datelly - Home</title>
		
		<!-- bootstrap - link cdn -->
        <!-- <link rel="stylesheet" href="css/bootstrap-4.5.0.min.css"> -->
        <link rel="stylesheet" href="css/dataTables.min.css">

        <script type="text/javascript" charset="utf8" src="js/jquery-3.5.1.min.js"></script>
        <!-- <script type="text/javascript" charset="utf8" src="js/bootstrap4.min.js"></script> -->
        <script type="text/javascript" charset="utf8" src="js/dataTables.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->
        <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
      </head>
		<!-- estilo -->
        <!-- <link href="css/style.css" rel="stylesheet"> -->
        <style>
            .entryInfo{
                z-index: 4;
                position: absolute; 
                width: 70%;
            }
            /* body{
                background-image: url('images/tribal.jpg');
            } */
        </style>

        </style>
	</head>

	<body>
        <div class="container">
            <div class="jumbotron jumbotron-fluid">
                <div class="container">
                  <h1 class="display-4">je t'aime</h1>
                  <p class="lead">Les nouveaux objectifs sont les bienvenus.</p>
                </div>
              </div>
            <form id="formInsert">
                <div class="form-group">
                    <label for="newGoals">Nova Meta</label>
                    <div class='row'>
                        <div class="input-group col-4">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">#</span>
                              </div>
                            <input type="text" class="form-control" id="newGoals" placeholder="Insira uma nova meta" aria-label="Insira uma nova meta" aria-describedby="basic-addon2">
                            <div class="input-group-append">
                              <button class="btn btn-outline-secondary" type="button" id="saveGoal" >Salvar</button>
                            </div>
                        </div> 
                    </div>
                </div>
            </form>
            
            <hr />

            <!-- <table id="table_id" class="table table-striped table-bordered" style="width:100%"> -->
            <table id="table_id">
                <thead style="background-color: #e9ecef">
                    <tr>
                        <th>id</th>
                        <th>Meta</th>
                        <th>Criada Por</th>
                        <th>Data Conclusão</th>
                        <th>Data Criação</th> 
                        <th>#</th> 
                    </tr>
                </thead>
            </table> 
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="goal-title"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body"> 

                        <div class="row">
                            <div class="col-6">
                                <label for="basic-url">Criado Por</label>
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                      <span class="input-group-text" id="basic-addon1">@</span>
                                    </div>
                                    <input type="text" class="form-control" id="goal-create-by" aria-describedby="basic-addon1" disabled>
                                </div>
                            </div>
                            <div class="col-6">
                                <label for="basic-url" >Data Criação</label>
                                <div class="input-group mb-3">
                                    <input type="date" class="form-control" id="goal-create-date" aria-describedby="basic-addon1" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <label for="basic-url">Observação</label>
                            <textarea class="form-control" id="goal-observation" rows="3"></textarea>
                        </div>

                        <div class="row justify-content-md-center">
                            <div class="col-8">
                                <label for="basic-url">Data Conclusão</label>
                                <div class="input-group mb-3">
                                    <input type="date" class="form-control" id="goal-date-concluded" aria-describedby="basic-addon1">
                                    <div class="input-group-append">
                                        <button type="button" class="btn" id="data-concluded-clear">Limpar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirm">Excluir</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" id="modal-save-goals">Salvar</button>
                    </div>
                </div>
            </div>
        </div> 

        

        <div class="modal fade" id="confirm" role="dialog">
            <div class="modal-dialog modal-md">

                <div class="modal-content">
                    <div class="modal-body">
                        <p>DESEJA EXCLUIR A META ??</p>
                    </div>
                    <div class="modal-footer">
                        <a href="#" type="button" class="btn btn-danger" id="delete-force-goal">Apagar Registo</a>
                            <button type="button" data-dismiss="modal" class="btn btn-default">Cancelar</button>
                    </div>
                </div>

            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-copyright text-center py-3">© 2020 Copyright  
                <p"> by Kaic Melo Santos</p>
            </div>
        </footer>
    </body>
</html> 
        <!-- <script src="/socket.io/socket.io.js"></script> -->
        
        <script>    
        
            // var socket = io('http://localhost/3000');

            // socket.on('sendEntrySystem', function(data){
            //     $('#entryInfo').text('');

            //     var html ="<p>"+ data.login+data.mensagem;+"</p>"
                 
            //     $('#entryInfo').append(html); 
                
            //     $('#entryInfo').show(4000);  
            //     $('#entryInfo').hide(5000);  
            // });  

            $(document).ready(function() {

                    var table= $('#table_id').DataTable( {
                        "language": {
                        "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Portuguese.json"
                    },
                    "ajax": "getGoals",
                    "order":[0,'desc'],
                    "columns": [
                        { "data": "id" },
                        { "data": "name" },
                        { "data": "rk_user_id" },
                        { 
                            data: 'concluded',
                            render:  data => {
                                if(data != null)
                                {
                                   return currentDateFormated(data);
                                }else{return null}
                            }
                        }, 
                        { 
                            data: 'created_at',
                            render:  data => currentDateFormated(data) 
                        }, 
                        { 
                            data: 'id',
                            render:  data => `<button type="button" value="'+data+'" class="btn" data-toggle="modal" data-target="#exampleModal"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-gear-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 0 0-5.86 2.929 2.929 0 0 0 0 5.858z"/>
</svg></button>`
                        }, 
                    ]
                });

                $("#saveGoal").click(function(){
                    $.ajax({
                        url: "/createGoals",
                        method: "POST",
                        data: { name : $("#newGoals").val().capitalize() },
                        dataType: "html"
                    }).done(function(data) {
                        $('#table_id').DataTable().ajax.reload();
                        $('#newGoals').val(``);
                    }).fail(function() {
                        console.log('algo deu errado');
                    }); 
                });

                $("#table_id tbody").on( 'click', 'button', function () {
                    var dataRow = table.row( $(this).parents('tr') ).data();                   
                    $("#goal-date-concluded").val('');

                    $("#goal-title").html(dataRow.name);
                    $("#goal-create-by").val(dataRow.rk_user_id);
                    $("#goal-create-date").val(dateForInput(dataRow.created_at));
                    // $("#goal-create-date").val(dataRow.created_at);
                    $("#goal-observation").val(dataRow.obs);
                    if(dataRow.concluded)
                    {
                        $("#goal-date-concluded").val(dateForInput(dataRow.concluded));
                    }

                    $("#modal-save-goals").click(function(avent){
                        $.ajax({
                            url: "/updateGoals", 
                            method: "POST",
                            data: {
                                id : dataRow.id,
                                obs : $("#goal-observation").val(),
                                concluded : $("#goal-date-concluded").val()
                            } ,
                            dataType: "json",
                            beforeSend : function(data){
                                $('#exampleModal').modal('hide');
                                $('#table_id').DataTable().ajax.reload(); 
                            }
                        });
                    });

                    $("#data-concluded-clear").click(function(avent){
                        $("#goal-date-concluded").val('');
                    });

                    
                    $("#delete-force-goal").click(function(avent){
                            $.ajax({
                                url: "/deleteGoal", 
                                method: "POST",
                                data: {id : dataRow.id} ,
                                dataType: "text" 
                            }).done(function(data) {
                                $('#exampleModal').modal('hide');
                                $('#confirm').modal('hide');
                                $('#table_id').DataTable().ajax.reload();
                            }).fail(function() { 
                                console.log('Erro ao deletar meta');
                            }); 
                    });
                });        
            });

            String.prototype.capitalize = function() {
                return this.charAt(0).toUpperCase() + this.slice(1);
            }

            function currentDateFormated(date){
                var data = new Date(date),
                    dia  = data.getDate().toString(),
                    diaF = (dia.length == 1) ? '0'+dia : dia,
                    mes  = (data.getMonth()+1).toString(), //+1 pois no getMonth Janeiro começa com zero.
                    mesF = (mes.length == 1) ? '0'+mes : mes,
                    anoF = data.getFullYear();
                return diaF+"/"+mesF+"/"+anoF;
            }

            function dateForInput(date){
                var data = new Date(date),
                    dia  = data.getDate().toString(),
                    diaF = (dia.length == 1) ? '0'+dia : dia,
                    mes  = (data.getMonth()+1).toString(), //+1 pois no getMonth Janeiro começa com zero.
                    mesF = (mes.length == 1) ? '0'+mes : mes,
                    anoF = data.getFullYear();
                return anoF+"-"+mesF+"-"+diaF;
            }

        </script> 
    </body>
</html> 
